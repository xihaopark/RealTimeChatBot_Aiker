# 🎯 音频问题诊断指南

## 问题描述
- **核心问题**: 没有音频听到，没有语音检测
- **症状**: SIP连接成功，RTP会话建立，但无音频
- **目标**: 从最基础开始诊断，确认问题根源

## 🔧 诊断工具

### 1. RTP信号检测器 (`rtp_signal_detector.py`)
**功能**: 纯粹的网络层诊断，只检测UDP包，不解码音频

**使用方法**:
```bash
# 快速扫描（10秒）
python3 rtp_signal_detector.py quick

# 扫描特定端口
python3 rtp_signal_detector.py port 10000

# 完整扫描（30秒）
python3 rtp_signal_detector.py scan
```

**预期结果**:
- ✅ 如果看到UDP包 → 网络通的，继续下一步
- ❌ 如果没有任何包 → 防火墙/NAT问题

### 2. 最小化SIP/RTP测试 (`minimal_sip_rtp_test.py`)
**功能**: 极简SIP实现，只接听电话，检测RTP流

**使用方法**:
```bash
python3 minimal_sip_rtp_test.py
```

**测试步骤**:
1. 启动测试
2. 拨打测试号码
3. 观察输出：
   - 是否收到INVITE？
   - SDP中的IP和端口是什么？
   - 是否有RTP包到达？

### 3. 诊断脚本 (`diagnose_audio_issue.py`)
**功能**: 自动化诊断流程

**使用方法**:
```bash
python3 diagnose_audio_issue.py
```

## 📋 诊断步骤

### 第1步：确认网络层
```bash
# 运行RTP信号检测器
python3 rtp_signal_detector.py quick
```

**关键检查点**:
- 本地IP是否正确？
- 是否有防火墙阻止？
- 端口是否被占用？

### 第2步：运行最小化测试
```bash
python3 minimal_sip_rtp_test.py
```

**关键检查点**:
- 是否收到INVITE？
- SDP解析是否成功？
- RTP端口是否正确？
- 是否有RTP包到达？

### 第3步：分析结果

**问题1：完全没有RTP包**
- 检查防火墙：`sudo iptables -L -n | grep udp`
- 检查端口：SDP中的端口是否正确？
- 检查NAT：对方能到达你的IP吗？

**问题2：有UDP包但不是RTP**
- 查看包的前12字节
- RTP包应该以 `80 00` 或 `80 08` 开头
- 检查是否加密（SRTP）

**问题3：双向问题**
- 你发送的包对方收到了吗？
- 对方发送的包你收到了吗？

## 🎯 关键诊断点

### 网络层诊断
```
📦 包 #1 来自 (192.168.1.100, 5060) -> 端口 10000
   大小: 172 字节
   RTP头: V=2, PT=0, Seq=1234, TS=5678
   SSRC: 0x12345678
   ✅ 有效的RTP包
   🎵 PCMU (G.711 μ-law)
   前16字节: 80000000000000000000000000000000
```

### SIP层诊断
```
📞 来电: 1234567890
   Call-ID: abc123@192.168.1.100
🎵 远程RTP: 192.168.1.100:10000
   编码: ['0', '8']
📤 发送: 200 OK (with PCMU SDP)
```

### RTP层诊断
```
📥 RTP包 #1 来自 (192.168.1.100, 10000)
   大小: 172字节, PT=0, Seq=1234
   时间戳: 5678, SSRC=0x12345678
   ✅ 有效RTP包
📊 RTP统计: 50包, 速率: 25.0包/秒
```

## 🚀 立即运行

### 快速诊断（推荐）
```bash
# 1. 先运行信号检测器
python3 rtp_signal_detector.py quick

# 2. 如果没有检测到，运行最小化测试
python3 minimal_sip_rtp_test.py

# 3. 拨打测试号码，观察输出
```

### 完整诊断
```bash
# 运行自动化诊断脚本
python3 diagnose_audio_issue.py
```

## 📊 诊断结果分析

### 成功案例
```
✅ 网络层正常
✅ 检测到RTP流量
✅ SIP协商成功
✅ RTP包格式正确
❌ 音频编解码问题
```

### 失败案例
```
❌ 未检测到任何RTP包
❌ 防火墙阻止UDP流量
❌ NAT配置问题
❌ 对方未发送RTP包
```

## 🔧 常见问题解决

### 1. 防火墙问题
```bash
# 检查防火墙
sudo iptables -L -n | grep udp

# 临时开放端口
sudo iptables -A INPUT -p udp --dport 10000:20000 -j ACCEPT
```

### 2. NAT问题
- 检查路由器端口转发
- 确认公网IP映射
- 验证STUN/TURN配置

### 3. 端口冲突
```bash
# 检查端口占用
netstat -tuln | grep 10000

# 释放端口
sudo lsof -ti:10000 | xargs kill -9
```

## 📝 报告模板

### 诊断报告
```
# 音频问题诊断报告

**诊断时间**: 2025-06-26 23:30:00

## 测试结果
- RTP信号检测: [成功/失败]
- 最小化SIP测试: [成功/失败]
- 音频双向通信: [正常/异常]

## 问题分析
- 网络层: [正常/异常]
- SIP层: [正常/异常]
- RTP层: [正常/异常]
- 音频层: [正常/异常]

## 建议解决方案
1. [具体建议]
2. [具体建议]
3. [具体建议]
```

## 🎯 下一步行动

1. **立即运行诊断工具**
2. **记录所有测试结果**
3. **分析问题根源**
4. **实施针对性修复**
5. **重新测试验证**

---

**记住**: 从最基础开始，一步一步确认每个环节！ 