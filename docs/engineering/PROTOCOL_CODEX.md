# VTX AI Phone System - 底层协议工程守则 v1.0

## 1. 核心宗旨

本守则是为了在AI服务本地化改造过程中，**绝对保护**底层通信协议的稳定性和兼容性。所有开发活动，无论是人工还是AI辅助，都必须严格遵守本守则。

## 2. ⚠️ 不可修改的核心模块

以下模块是系统的基石，任何未经授权的修改都将破坏系统的核心功能。

### 2.1 SIP信令层

- **保护目标**: `main.py` 中的 `EnhancedSIPClient` 类
- **保护原因**: 核心SIP协议栈，直接关系到与VTX PBX系统的信令交互、注册、认证和呼叫控制。
- **严禁修改**:
  - `EnhancedSIPClient` 类的内部逻辑。
  - `_build_register()`: SIP注册消息的构建逻辑。
  - `_build_auth_header()`: SIP认证头的生成算法。
  - `_parse_auth_header()`: SIP认证头的解析逻辑。

### 2.2 RTP音频传输层

- **保护目标**: `main.py` 中的 `RTPHandler` 类
- **保护原因**: 实时音频流处理，严格遵循RFC 3550标准。
- **严禁修改**:
  - `RTPHandler` 类的核心处理流程。
  - `_build_rtp_packet()`: RTP包结构，特别是12字节的头部格式。
  - 序列号（Sequence Number）和时间戳（Timestamp）的递增逻辑。
  - SSRC（Synchronization Source）的生成和管理机制。

### 2.3 G.711音频编解码器

- **保护目标**: `main.py` 中的 `G711Codec` 类
- **保护原因**: 电话系统的标准音频编解码算法。
- **严禁修改**:
  - `G711Codec` 类的编解码算法。
  - `linear_to_ulaw()`: μ-law编码的核心实现。
  - `ULAW_BIAS = 132`: G.711标准定义的编码偏置常数。
  - **采样率**: 必须保持 `8000Hz`。
  - **帧大小**: 必须保持 `160字节`（对应20ms的音频数据）。

### 2.4 SDP协议处理

- **保护目标**: `main.py` 中的 `SDPParser` 类
- **保护原因**: 会话描述协议（SDP）是媒体协商的关键，格式需严格遵循RFC 4566。
- **严禁修改**:
  - `SDPParser` 的解析和构建逻辑。
  - **媒体描述格式**: 必须为 `m=audio [port] RTP/AVP 0 8`。
  - **编解码映射**: 必须包含 `a=rtpmap:0 PCMU/8000`。

## 3. 🔒 锁定的关键参数

为了确保协议的一致性，以下参数被定义在 `config/protocol_constants.yaml` 中，并且**严禁修改**。

- **SIP端口**: 5060
- **RTP端口范围**: 10000-10500
- **音频采样率**: 8000 Hz
- **RTP帧大小**: 160 字节
- **音频编码**: "mulaw" (PCMU)
- **RTP载荷类型**: PCMU=0, PCMA=8

## 4. 审批与审查流程

任何对上述保护内容的修改请求都必须经过以下严格的审查流程：

1.  **提交技术评审（Tech Review）**:
    *   撰写详细的技术评审文档，说明修改的必要性、技术方案和潜在风险。
    *   提供完整的影响分析报告，包括对现有系统和兼容性的影响。
2.  **提供测试报告**:
    *   提供完整的单元测试、集成测试和兼容性测试报告。
    *   必须包含与现有VTX PBX系统连接的测试结果。
3.  **获取书面批准**:
    *   必须获得项目负责人和架构师的书面批准后方可进行修改。

---

**本守则是项目的最高准则，任何违反本守则的行为都可能导致项目失败。AI助手和开发人员都必须无条件遵守。** 